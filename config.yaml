# MAPA_FRENTES - Configuracion
# Herramienta para generar mapas de frentes meteorologicos

area:
  lon_min: -70.0
  lon_max: 40.0
  lat_min: 25.0
  lat_max: 65.0
  data_padding_deg: 10.0   # Grados extra para descarga de datos (cubre esquinas Lambert)

isobars:
  interval_hpa: 4
  smooth_sigma: 2.0
  linewidth: 0.6
  color: "#333333"
  label_fontsize: 6

pressure_centers:
  filter_size: 9            # puntos de ventana para min/max filter (~5deg a 0.25deg)
  min_distance_deg: 4.5     # menos centros secundarios (más estilo sinóptico)
  secondary_radius_deg: 5.0 # radio para clasificar primario/secundario
  high_min_pressure: 1012.0 # no marcar H si presion < este valor (hPa)
  low_max_pressure: 1012.0  # no marcar L si presion > este valor (hPa)
  min_depth_hpa: 1.0        # profundidad minima (dif. con presion media entorno)
  depth_radius_deg: 3.0     # radio para calcular presion media del entorno
  h_color: "#0044CC"
  l_color: "#CC0000"
  fontsize: 11
  fontweight: "bold"
  high_label: "A"            # etiqueta para anticiclon (estilo AEMET)
  low_label: "B"             # etiqueta para borrasca (estilo AEMET)

tfp:
  # ===== Suavizado (Sansom & Catto 2024) =====
  smoothing_method: "npass"        # "npass" (paper) o "gaussian" (legacy)
  smoothing_passes: 50             # paper: n=96. Ajustado: 40=muchos frentes, 60=pocos, 50=equilibrio
  smooth_sigma: 8.0                # solo se usa si smoothing_method="gaussian"
  #gradmag_smooth_sigma: 4.8       # ~ smooth_sigma*0.6 (para estabilizar TFL)

  # ===== Método principal =====
  use_contour_method: true         # H98 contour-then-mask (TFL=0)
  contour_margin_px: 3

  # ===== H98 thresholds: K1 (TFP) y K2 (ABZ) =====
  # K1 <= 0, K2 >= 0 (Sansom & Catto 2024, Sect. 3.2)
  # Valores climatologicos del paper (cap/floor si cuantiles activados)
  k1_tfp: -1.6e-11                # paper: percentil 25 de TFP (-1.6e-11 K m-2)
  k2_abz: 1.0e-5                  # paper: 7.5e-6. Subido para filtrar frentes debiles cerca de B
  abz_use_raw_gradient: true       # paper Eq.3: ABZ usa |grad theta_w| sin re-suavizar

  # Cuantiles (usar false para valores fijos del paper; true para adaptativos)
  use_quantile_thresholds: false
  quantile_lat_min: 23.4
  quantile_lat_max: 66.6

  # paper sugiere K1=q0.25 de TFP, K2=q0.50 de |grad|ABZ (extra-trópicos) 
  k1_tfp_quantile: 0.25
  k2_abz_quantile: 0.50

  # Estabilizadores para no pasarte (recomendado en operativo)
  k1_use_cap: true               # K1 = min(k1_tfp, qK1)  (evita K1 demasiado "suave")
  k2_use_floor: true             # K2 = max(k2_abz, qK2)  (evita K2 demasiado bajo)

  # ===== Filtros físicos opcionales (NO en Sansom & Catto 2024) =====
  use_f_diagnostic: false         # Parfitt et al. — desactivado (no en paper)
  # Si activas cuantiles para F, el threshold se toma de la distribución instantánea (más robusto)
  use_f_quantile_threshold: true
  f_quantile: 0.60
  f_diagnostic_threshold: 0.60   # fallback si no hay cuantiles/datos

  use_mslp_filter: false          # filtro ciclonico MSLP — desactivado (no en paper)
  mslp_laplacian_sigma: 2.5
  # En vez de >0 (muy agresivo), usa corte por percentil de la laplaciana (más permisivo)
  mslp_use_percentile_cut: true
  mslp_laplacian_percentile: 0.40
  mslp_laplacian_cut: 0.0        # fallback si no hay percentil/datos

  # ===== Geometría / postproceso =====
  min_front_points: 6
  min_front_length_km: 250.0       # paper: 250 km gran-circulo
  min_front_length_deg: 3.0        # solo para pipeline legacy DBSCAN
  max_fronts: 0                  # 0 = sin límite (para test). En operativo: 30
  spline_smoothing: 0.6
  max_points_per_front: 120

  # ===== Legacy (si algún día pruebas mask-then-join) =====
  gradient_threshold: 2.0e-6     # usado SOLO por legacy find_zero_crossings
  dbscan_eps_deg: 2.2
  dbscan_min_samples: 3
  simplify_tolerance_deg: 0.12
  max_hop_deg: 3.0
  angular_weight: 0.55
  merge_distance_deg: 3.0
  use_frontogenesis_filter: false
  frontogenesis_percentile: 25

  # ===== Vorticity boost (legacy) =====
  use_vorticity_boost: true
  vorticity_boost_threshold: 4.0e-5
  vorticity_boost_factor: 0.65

plotting:
  figsize: [18, 11]
  dpi: 150
  projection: "LambertConformal"
  projection_params:
    central_longitude: -15.0
    central_latitude: 45.0
    standard_parallels: [30.0, 60.0]
  coastline_color: "#555555"
  coastline_linewidth: 0.6
  border_color: "#AAAAAA"
  border_linewidth: 0.3
  ocean_color: "#D6EAF8"
  land_color: "#F5F0E8"
  front_linewidth: 1
  front_symbol_size: 1.6
  front_symbol_spacing: 1.9

center_fronts:
  search_radius_deg: 6.5
  trace_step_deg: 0.5
  max_front_length_deg: 16
  max_turn_deg: 55              # permite curvatura natural
  gradient_cutoff_factor: 0.25
  spline_smoothing: 0.35
  max_association_distance_deg: 8
  require_low_center: true       # solo frentes cerca de centros L (borrascas)
  max_distance_to_low_deg: 12.0  # radio maximo alrededor de cada L
  association_strategy: "min_along_front"  # "ends" (legacy) o "min_along_front" (recomendado)
  extend_to_center: true                   # para que no queden “cortados” lejos del centro
  extend_max_distance_km: 800              # límite para extender (evita unir cosas lejanas raras)

temporal:
  enabled: true
  context_steps: [-6, -3, 0, 3, 6]
  match_distance_deg: 2.5
  min_persistence: 3             # 4 era muy estricto; 3 se parece más a “criterio humano”

instability_lines:
  enabled: true
  smooth_sigma: 5.0
  convergence_threshold: 3.5e-5
  min_length_deg: 3.0

export:
  default_format: "png"
  png_dpi: 300
  pdf_dpi: 150

data:
  cache_dir: "data/cache"
  output_dir: "data/output"
  sessions_dir: "data/sessions"

ecmwf:
  source: "aws"
  model: "ifs"
  resol: "0p25"
  step: 0
  surface_params:
    - "msl"
    - "tp"
  pressure_levels: [500, 700, 850]
  pressure_params:
    - "t"
    - "q"
    - "u"
    - "v"
    - "vo"  # vorticidad relativa

background_field:
  default_field: "none"      # "none", "theta_e_850", "grad_theta_e_850",
                             # "thickness_1000_500", "temp_advection_850", "wind_speed_850"
  alpha: 0.45                # transparencia del contourf
  num_levels: 20             # numero de niveles de contorno
  colorbar: true             # mostrar colorbar

precipitation:
  threshold_mm: 0.5      # no dibujar por debajo de este valor (transparente)
  alpha: 0.5             # transparencia del contourf
  cmap: "YlGnBu"         # colormap
  num_levels: 15         # niveles de contorno

wind_vectors:
  thin_factor: 5         # cada N puntos de la rejilla (0.25deg * 8 = 2deg)
  scale: 6000            # escala del quiver (mayor = flechas mas cortas)
  width: 0.0005          # grosor de las flechas
  color: "#555555"       # color de las flechas
  alpha: 1.0             # transparencia (1.0 = opaco)
  web_scale_factor: 0.1  # multiplicador de scale para web (mayor = flechas mas cortas en web)
  web_width_factor: 0.6  # multiplicador de width para web (menor = mas finas en web)

occlusion:
  enabled: true
  min_score: 0.60
  vsi_threshold: 0.10
  vorticity_threshold: 8.0e-5
  t_pattern_radius_deg: 5.0
  t_pattern_max_angle: 90.0
  use_multilevel: true
